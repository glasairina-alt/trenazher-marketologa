import type { Message, StageType } from "@/types/stages";

interface StageHandlerParams {
  currentStage: StageType;
  userInput: string;
  setCurrentStage: (stage: StageType) => void;
  addMessage: (text: string, type: Message["type"], imageUrl?: string) => void;
  setFileAttachEnabled: (enabled: boolean) => void;
  setIsCabinetLocked: (locked: boolean) => void;
  showTyping: () => Promise<void>;
  hideTyping: () => Promise<void>;
  sleep: (ms: number) => Promise<unknown>;
}

export const handleStageLogic = async ({
  currentStage,
  userInput,
  setCurrentStage,
  addMessage,
  setFileAttachEnabled,
  setIsCabinetLocked,
  showTyping,
  hideTyping,
  sleep,
}: StageHandlerParams) => {
  await sleep(500);
  await showTyping();
  await sleep(1000 + Math.random() * 1000);
  await hideTyping();

  switch (currentStage) {
    case "STAGE_1_INITIAL_REPLY":
      addMessage(
        "–û—á–µ–Ω—å –ø—Ä–æ—à—É –ø–æ–º–æ–≥–∏—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–µ–∫–ª–∞–º—É. –£ –Ω–∞—Å –º–∞–≥–∞–∑–∏–Ω \"–§–ª–æ—Ä–ê–Ω–Ω–∞\" –≤ –ö–∞–ª—É–≥–µ, –ø—Ä–æ–¥–∞–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–æ–∑—ã, —Ç—é–ª—å–ø–∞–Ω—ã, –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –≤ –∫–æ—Ä–æ–±–∫–∞—Ö. –°–µ–π—á–∞—Å —Ö–æ—Ç–∏–º –ø—Ä–æ–¥–∞—Ç—å –ø–æ–¥–∞—Ä–æ—á–Ω—ã–µ –Ω–∞–±–æ—Ä—ã \"—Ü–≤–µ—Ç—ã + —à–æ–∫–æ–ª–∞–¥–∫–∞\". –ú–Ω–µ –Ω–µ–∫–æ–≥–¥–∞ –≤—Å—ë –ø–æ–¥—Ä–æ–±–Ω–æ –æ–±—ä—è—Å–Ω—è—Ç—å ‚Äî —Å–¥–µ–ª–∞–π—Ç–µ, –∫–∞–∫ —É –≤—Å–µ—Ö, —á—Ç–æ–±—ã –±—ã–ª–æ –∫—Ä–∞—Å–∏–≤–æ –∏ —à–ª–∏ –∑–∞–∫–∞–∑—ã.",
        "bot"
      );
      setCurrentStage("STAGE_1_WAIT_FOR_REPLY");
      break;

    case "STAGE_1_WAIT_FOR_REPLY":
      addMessage(
        "–£ –º–µ–Ω—è –µ—Å—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –±—É–∫–µ—Ç–æ–≤. –Ø —Å–µ–π—á–∞—Å –Ω–∏–∂–µ –≤–∞–º –ø—Ä–∏—à–ª—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏. –ö–∞–∫ —Å–¥–µ–ª–∞–µ—Ç–µ –∫—Ä–µ–∞—Ç–∏–≤—ã, –ø—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ –∏—Ö –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ.",
        "bot"
      );
      await sleep(1000);
      addMessage("", "bot-image");
      addMessage("", "bot-image");
      addMessage("", "bot-image");
      await sleep(500);
      addMessage(
        "**–ó–∞–¥–∞—á–∞:** –í–∞—à–∞ –∑–∞–¥–∞—á–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å 1 –∫—Ä–µ–∞—Ç–∏–≤. –í—ã –µ–≥–æ –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å –≤ –ª—é–±–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ. –ü–æ—Å–ª–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫—Ä–µ–∞—Ç–∏–≤–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ —Å–∫—Ä–µ–ø–∫—É.",
        "system-alert"
      );
      setFileAttachEnabled(true);
      setCurrentStage("STAGE_2_CREATIVE_1");
      break;

    case "STAGE_2_CREATIVE_1":
      addMessage("–í–∞–º –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—Ä–µ–∞—Ç–∏–≤ —á–µ—Ä–µ–∑ —Å–∫—Ä–µ–ø–∫—É üìé", "system-alert");
      break;

    case "STAGE_2_CREATIVE_2":
      addMessage(
        "–í–∞–º –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –í–¢–û–†–û–ô, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫—Ä–µ–∞—Ç–∏–≤ —á–µ—Ä–µ–∑ —Å–∫—Ä–µ–ø–∫—É üìé",
        "system-alert"
      );
      break;

    case "STAGE_3_LAUNCH":
      addMessage(
        "**–ü–æ–¥—Å–∫–∞–∑–∫–∞:** –í–∞–º –Ω—É–∂–Ω–æ –∑–∞–π—Ç–∏ –≤ —Ä–µ–∫–ª–∞–º–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç (—Å–ø—Ä–∞–≤–∞) –∏ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É \"–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é\".",
        "system-alert"
      );
      break;

    case "STAGE_3_LAUNCH_WAIT_USER":
      addMessage("–ó–¥–æ—Ä–æ–≤–æ! –û—á–µ–Ω—å –∂–¥–µ–º –ø–µ—Ä–≤—ã–µ –∑–∞—è–≤–∫–∏.", "bot");
      await sleep(2000);
      addMessage("**–ü—Ä–æ—à–ª–æ 2 —á–∞—Å–∞.**", "system");
      await sleep(1000);
      await showTyping();
      await sleep(1500);
      await hideTyping();
      addMessage(
        "–ê –≥–¥–µ –º–æ–∏ –∑–∞—è–≤–∫–∏? –í—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏ —Ä–µ–∫–ª–∞–º—É, —É–∂–µ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –¥–µ–Ω—å–≥–∏, –∞ –∑–∞—è–≤–æ–∫ –Ω–µ—Ç.",
        "bot"
      );
      await sleep(500);
      addMessage(
        "**–ó–∞–¥–∞—á–∞:** –û—Ç–≤–µ—Ç—å—Ç–µ –≤–∞—à–µ–º—É –∫–ª–∏–µ–Ω—Ç—É.",
        "system-alert"
      );
      setCurrentStage("STAGE_4_PANIC");
      break;

    case "STAGE_4_PANIC":
      addMessage(
        "–•–æ—Ä–æ—à–æ, –ø–æ–¥–æ–∂–¥–µ–º –µ—â–µ, –Ω–æ –µ—Å–ª–∏ –∑–∞—è–≤–æ–∫ –Ω–µ –±—É–¥–µ—Ç –≤—ã –≤–µ—Ä–Ω–µ—Ç–µ –≤—Å–µ –º–æ–∏ –∑–∞—Ç—Ä–∞—Ç—ã.",
        "bot"
      );
      await sleep(2000);
      addMessage("**–ü—Ä–æ—à–ª–æ –µ—â–µ 2 —á–∞—Å–∞.**", "system");
      await sleep(1500);
      await showTyping();
      await sleep(1000);
      await hideTyping();
      addMessage(
        "–û–π, —Å–ª—É—à–∞–π—Ç–µ, –ø–æ—à–ª–∏ –∑–∞–∫–∞–∑—ã! üéâ –°–ø–∞—Å–∏–±–æ, –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –∫—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞–ª —Ä–µ–∫–ª–∞–º—É –Ω–æ—Ä–º–∞–ª—å–Ω–æ!",
        "bot"
      );
      await sleep(1000);
      addMessage(
        "**–ó–∞–¥–∞—á–∞:** –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤ —Ä–µ–∫–ª–∞–º–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏. –û—Ç–≤–µ—Ç—å—Ç–µ –∫–ª–∏–µ–Ω—Ç—É.",
        "system-alert"
      );
      setCurrentStage("STAGE_5_ORDERS_COMING");
      break;

    case "STAGE_5_ORDERS_COMING":
      addMessage(
        "–û, —É –Ω–∞—Å –ø—Ä–∏–ª–µ—Ç–µ–ª–æ —É–∂–µ 10 –∑–∞—è–≤–æ–∫.",
        "bot"
      );
      await sleep(2000);
      addMessage(
        "**–ù–∞—Å—Ç—É–ø–∏–ª–æ 15 —Ñ–µ–≤—Ä–∞–ª—è. –í—Ä–µ–º—è 16:00.** –ü–æ—Ä–∞ —Å–¥–µ–ª–∞—Ç—å –æ—Ç—á–µ—Ç. –°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç –∏ —Ä–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ. –í —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –≤–∞–º –∫–∞–∫–∏—Ö-—Ç–æ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç, –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –∏—Ö —É –∫–ª–∏–µ–Ω—Ç–∞.",
        "system"
      );
      setCurrentStage("STAGE_5_REPORT");
      break;

    case "STAGE_5_REPORT":
      await showTyping();
      await sleep(1500);
      await hideTyping();
      addMessage(
        "**–ü—Ä–æ—à–ª–æ 3 —á–∞—Å–∞. –ö–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.** –ù–∞–ø–æ–º–Ω–∏—Ç–µ –µ–º—É –æ —Ç–æ–º, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ—Ç—á–µ—Ç–∞ –ø–æ —Ä–µ–∫–ª–∞–º–µ.",
        "system"
      );
      await sleep(1000);
      addMessage(
        "**–ü–æ–¥—Å–∫–∞–∑–∫–∞:** –ù–∞–ø–æ–º–Ω–∏—Ç–µ –ê–Ω–Ω–µ –≤ —á–∞—Ç–µ, —á—Ç–æ –≤—ã –∂–¥–µ—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –Ω–µ–µ.",
        "system-alert"
      );
      setCurrentStage("STAGE_6_REPORT_WAIT");
      break;

    case "STAGE_6_REPORT_WAIT":
      addMessage(
        "–£ –º–µ–Ω—è —Ç—É—Ç –¥–æ–º–∞ –ø–æ—Ç–æ–ø –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ, –º–Ω–µ –Ω–µ –¥–æ –≤–∞—à–∏—Ö —Ü–∏—Ñ—Ä. –ü—Ä–∏—à–ª—é –∫–∞–∫ —Å–º–æ–≥—É.",
        "bot"
      );
      await sleep(2000);
      addMessage(
        "**–ù–∞—Å—Ç—É–ø–∏–ª–æ 16 —Ñ–µ–≤—Ä–∞–ª—è.** –ù–∞—Å—Ç–æ–π—á–∏–≤–æ –Ω–∞–ø–æ–º–Ω–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—á–µ—Ç–∞.",
        "system"
      );
      setCurrentStage("STAGE_7_REPORT_DATA");
      break;

    case "STAGE_7_REPORT_DATA":
      addMessage(
        "–Ø —Ç—É—Ç –∏—Å–∫–∞–ª–∞ —Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞, —É–±–∏—Ä–∞–ª–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É –∏ —Ä–µ—à–∞–ª–∞ –≤–æ–ø—Ä–æ—Å —Å —Å–æ—Å–µ–¥—è–º–∏, —Ç–∞–∫ –∫–∞–∫ —è –∏—Ö –∑–∞–ª–∏–ª–∞.",
        "bot"
      );
      await sleep(1500);
      addMessage(
        "–ú—ã –ø—Ä–æ–¥–∞–ª–∏ 20 –±—É–∫–µ—Ç–æ–≤ –∏ –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ 55 300 —Ä—É–±.",
        "bot"
      );
      await sleep(800);
      addMessage(
        "–ê –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –æ—Ç—á–µ—Ç –ø–æ —Ä–µ–∫–ª–∞–º–µ?",
        "bot"
      );
      await sleep(1000);
      addMessage(
        "**–ó–∞–¥–∞—á–∞:** –†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –≤—Å–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –æ—Ç—á–µ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –∫–ª–∏–µ–Ω—Ç—É, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É \"–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç\".",
        "system-alert"
      );
      setCurrentStage("STAGE_7_REPORT_DATA_2");
      break;

    case "STAGE_7_REPORT_DATA_2":
      addMessage(
        "–ù–∞–ø–æ–º–∏–Ω–∞—é: –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –û—Ç—á–µ—Ç, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å—á–µ—Ç—ã –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—Ç—á–µ—Ç.",
        "system-alert"
      );
      break;

    case "STAGE_8_REPORT_SUBMIT":
      addMessage(
        "**–ü–æ–¥—Å–∫–∞–∑–∫–∞:** –ù–∞–ø–æ–º–Ω–∏—Ç–µ –ê–Ω–Ω–µ –≤ —á–∞—Ç–µ, —á—Ç–æ –≤—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ—Ç—á–µ—Ç –∏ –∂–¥–µ—Ç–µ –µ–µ —Ä–µ–∞–∫—Ü–∏–∏.",
        "system-alert"
      );
      break;

    case "STAGE_8_REPORT_SENT":
      addMessage("–ü–æ—Å–º–æ—Ç—Ä—é –æ—Ç—á–µ—Ç –∑–∞–≤—Ç—Ä–∞.", "bot");
      await sleep(2000);
      addMessage("**–ù–∞—Å—Ç—É–ø–∏–ª–æ 17 —Ñ–µ–≤—Ä–∞–ª—è.**", "system");
      await sleep(1500);
      await showTyping();
      await sleep(1000);
      await hideTyping();
      addMessage(
        "–ü–æ—Å–º–æ—Ç—Ä–µ–ª–∞ –≤–∞—à –æ—Ç—á–µ—Ç. –ù–æ —è –Ω–∏—á–µ–≥–æ –≤ –Ω–µ–º –Ω–µ –ø–æ–Ω–∏–º–∞—é. –ß—Ç–æ —Ç–∞–∫–æ–µ CTR –∏ –≤—Å–µ –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–µ –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—ã. –ü–æ—è—Å–Ω–∏—Ç–µ –º–Ω–µ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.",
        "bot"
      );
      await sleep(500);
      addMessage(
        "**–ó–∞–¥–∞—á–∞:** –ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –∏ –æ–±—ä—è—Å–Ω–∏—Ç–µ –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã.",
        "system-alert"
      );
      setCurrentStage("STAGE_9_EXPLAIN");
      break;

    case "STAGE_9_EXPLAIN":
      addMessage("–°–ø–∞—Å–∏–±–æ, –Ω–µ–º–Ω–æ–≥–æ —Å—Ç–∞–ª–æ –ø–æ–Ω—è—Ç–Ω–µ–µ.", "bot");
      await sleep(1500);
      await showTyping();
      await sleep(1000);
      await hideTyping();
      addMessage(
        "–ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã —Ç–∞–º –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ ‚Äî —Ö–æ—á—É –ø–æ—Ç–æ–º –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–∞–º–∞.",
        "bot"
      );
      await sleep(500);
      addMessage(
        "**–ó–∞–¥–∞—á–∞:** –û—Ç–≤–µ—Ç—å—Ç–µ –∫–ª–∏–µ–Ω—Ç—É.",
        "system-alert"
      );
      setCurrentStage("STAGE_10_SETTINGS");
      break;

    case "STAGE_10_SETTINGS":
      addMessage(
        "–û–π, —Å–ª—É—à–∞–π—Ç–µ, —Å–ø–∞—Å–∏–±–æ –≤–∞–º –æ–≥—Ä–æ–º–Ω–æ–µ! üå∏ –†–µ–∫–ª–∞–º–∞ —Ä–µ–∞–ª—å–Ω–æ —Å—Ä–∞–±–æ—Ç–∞–ª–∞ ‚Äî —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–∞–∑—Ä—ã–≤–∞–ª—Å—è, –º—É–∂—á–∏–Ω—ã –ø–∏—Å–∞–ª–∏ –≤–µ—Å—å –¥–µ–Ω—å! –î–∞–∂–µ –Ω–µ –¥—É–º–∞–ª–∞, —á—Ç–æ —Ç–∞–∫ –±—ã—Å—Ç—Ä–æ –ø–æ–ª—É—á–∏—Ç—Å—è. –ï—Å–ª–∏ —Å–º–æ–∂–µ—Ç–µ –∫ 8 –º–∞—Ä—Ç–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞–º–ø–∞–Ω–∏—é, —è —Å —Ä–∞–¥–æ—Å—Ç—å—é –ø—Ä–æ–¥–æ–ª–∂—É —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ.",
        "bot"
      );
      await sleep(7000);
      addMessage(
        "**–ú–æ–ª–æ–¥–µ—Ü! üéâ** –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∫–µ–π—Å \"–°—Ä–æ—á–Ω—ã–π –∑–∞–ø—É—Å–∫ 14 —Ñ–µ–≤—Ä–∞–ª—è\".\n\n–í—ã –ø—Ä–æ—à–ª–∏ –≤–µ—Å—å –ø—É—Ç—å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞:\n‚úÖ –û–±—â–µ–Ω–∏–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º –∏ —É—Ç–æ—á–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á\n‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤\n‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏\n‚úÖ –†–∞–±–æ—Ç–∞ —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∫–ª–∏–µ–Ω—Ç–∞\n‚úÖ –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç—á–µ—Ç–∞\n‚úÖ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º\n\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –∫–µ–π—Å –∑–∞–Ω–æ–≤–æ, –≤–≤–µ–¥—è –∫–æ–º–∞–Ω–¥—É /start",
        "system"
      );
      setCurrentStage("FINAL");
      break;

    case "FINAL":
      addMessage(
        "–ö–µ–π—Å –∑–∞–≤–µ—Ä—à–µ–Ω. –í–≤–µ–¥–∏—Ç–µ /start —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.",
        "system-alert"
      );
      break;

    default:
      break;
  }
};
