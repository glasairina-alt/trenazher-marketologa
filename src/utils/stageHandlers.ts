import type { Message, StageType } from "@/types/stages";

interface StageHandlerParams {
  currentStage: StageType;
  userInput: string;
  setCurrentStage: (stage: StageType) => void;
  addMessage: (text: string, type: Message["type"], imageUrl?: string) => void;
  setFileAttachEnabled: (enabled: boolean) => void;
  setIsCabinetLocked: (locked: boolean) => void;
  showTyping: () => Promise<void>;
  hideTyping: () => Promise<void>;
  sleep: (ms: number) => Promise<unknown>;
}

export const handleStageLogic = async ({
  currentStage,
  userInput,
  setCurrentStage,
  addMessage,
  setFileAttachEnabled,
  setIsCabinetLocked,
  showTyping,
  hideTyping,
  sleep,
}: StageHandlerParams) => {
  await sleep(500);
  await showTyping();
  await sleep(1000 + Math.random() * 1000);
  await hideTyping();

  switch (currentStage) {
    case "STAGE_1_INITIAL_REPLY":
      addMessage(
        "–û—á–µ–Ω—å –ø—Ä–æ—à—É –ø–æ–º–æ–≥–∏—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–µ–∫–ª–∞–º—É. –£ –Ω–∞—Å –º–∞–≥–∞–∑–∏–Ω \"–§–ª–æ—Ä–ê–Ω–Ω–∞\" –≤ –ö–∞–ª—É–≥–µ, –ø—Ä–æ–¥–∞–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–æ–∑—ã, —Ç—é–ª—å–ø–∞–Ω—ã, –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –≤ –∫–æ—Ä–æ–±–∫–∞—Ö. –°–µ–π—á–∞—Å —Ö–æ—Ç–∏–º –ø—Ä–æ–¥–∞—Ç—å –ø–æ–¥–∞—Ä–æ—á–Ω—ã–µ –Ω–∞–±–æ—Ä—ã \"—Ü–≤–µ—Ç—ã + —à–æ–∫–æ–ª–∞–¥–∫–∞\". –ú–Ω–µ –Ω–µ–∫–æ–≥–¥–∞ –≤—Å—ë –ø–æ–¥—Ä–æ–±–Ω–æ –æ–±—ä—è—Å–Ω—è—Ç—å ‚Äî —Å–¥–µ–ª–∞–π—Ç–µ, –∫–∞–∫ —É –≤—Å–µ—Ö, —á—Ç–æ–±—ã –±—ã–ª–æ –∫—Ä–∞—Å–∏–≤–æ –∏ —à–ª–∏ –∑–∞–∫–∞–∑—ã.",
        "bot"
      );
      setCurrentStage("STAGE_1_WAIT_FOR_REPLY");
      break;

    case "STAGE_1_WAIT_FOR_REPLY":
      addMessage(
        "–£ –º–µ–Ω—è –µ—Å—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –±—É–∫–µ—Ç–æ–≤. –Ø —Å–µ–π—á–∞—Å –Ω–∏–∂–µ –≤–∞–º –ø—Ä–∏—à–ª—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏. –ö–∞–∫ —Å–¥–µ–ª–∞–µ—Ç–µ –∫—Ä–µ–∞—Ç–∏–≤—ã, –ø—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ –∏—Ö –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ.",
        "bot"
      );
      await sleep(1000);
      addMessage("", "bot-image");
      addMessage("", "bot-image");
      addMessage("", "bot-image");
      await sleep(500);
      addMessage(
        "**–ó–∞–¥–∞—á–∞:** –í–∞—à–∞ –∑–∞–¥–∞—á–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å 1 –∫—Ä–µ–∞—Ç–∏–≤. –í—ã –µ–≥–æ –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å –≤ –ª—é–±–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ. –ü–æ—Å–ª–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫—Ä–µ–∞—Ç–∏–≤–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ —Å–∫—Ä–µ–ø–∫—É.",
        "system-alert"
      );
      setFileAttachEnabled(true);
      setCurrentStage("STAGE_2_CREATIVE_1");
      break;

    case "STAGE_2_CREATIVE_1":
      addMessage("–í–∞–º –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—Ä–µ–∞—Ç–∏–≤ —á–µ—Ä–µ–∑ —Å–∫—Ä–µ–ø–∫—É üìé", "system-alert");
      break;

    case "STAGE_2_CREATIVE_2":
      addMessage(
        "–í–∞–º –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –í–¢–û–†–û–ô, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫—Ä–µ–∞—Ç–∏–≤ —á–µ—Ä–µ–∑ —Å–∫—Ä–µ–ø–∫—É üìé",
        "system-alert"
      );
      break;

    case "STAGE_3_LAUNCH":
      addMessage(
        "**–ü–æ–¥—Å–∫–∞–∑–∫–∞:** –í–∞–º –Ω—É–∂–Ω–æ –∑–∞–π—Ç–∏ –≤ —Ä–µ–∫–ª–∞–º–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç (—Å–ø—Ä–∞–≤–∞) –∏ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É \"–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é\".",
        "system-alert"
      );
      break;

    case "STAGE_3_LAUNCH_WAIT_USER":
      addMessage("–ó–¥–æ—Ä–æ–≤–æ! –û—á–µ–Ω—å –∂–¥–µ–º –ø–µ—Ä–≤—ã–µ –∑–∞—è–≤–∫–∏.", "bot");
      await sleep(3000);
      addMessage("**–ü—Ä–æ—à–ª–æ 2 —á–∞—Å–∞‚Ä¶**", "system");
      await sleep(1000);
      await showTyping();
      await sleep(1000);
      await hideTyping();
      addMessage(
        "–ß—Ç–æ-—Ç–æ —É –Ω–∞—Å –¥–æ —Å–∏—Ö –ø–æ—Ä –∑–∞—è–≤–æ–∫ –Ω–µ—Ç. –ß—Ç–æ –Ω–µ —Ç–∞–∫? –ú–æ–∂–µ—Ç —Ä–µ–∫–ª–∞–º–∞ –≤–æ–æ–±—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞? –ü—Ä–æ–≤–µ—Ä—å—Ç–µ!",
        "bot"
      );
      await sleep(500);
      addMessage(
        "**–ó–∞–¥–∞—á–∞:** –û–±—ä—è—Å–Ω–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É, —á—Ç–æ –Ω—É–∂–Ω–æ –≤—Ä–µ–º—è –¥–ª—è –Ω–∞–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.",
        "system-alert"
      );
      setCurrentStage("STAGE_4_PANIC");
      break;

    case "STAGE_4_PANIC":
      addMessage(
        "–ü–æ–Ω—è—Ç–Ω–æ, –ø–æ–¥–æ–∂–¥—É –µ—â–µ –ø–∞—Ä—É —á–∞—Å–æ–≤. –ù–æ –ø–æ—Ç–æ–º –∂–¥—É –æ—Ç –≤–∞—Å –æ—Ç—á–µ—Ç –ø–æ —Ä–µ–∫–ª–∞–º–µ.",
        "bot"
      );
      await sleep(2000);
      addMessage("**–ü—Ä–æ—à–ª–æ –µ—â–µ 2 —á–∞—Å–∞. –ü–æ—è–≤–∏–ª–∏—Å—å –ø–µ—Ä–≤—ã–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏.**", "system");
      await sleep(1000);
      addMessage(
        "**–ó–∞–¥–∞—á–∞:** –°–æ–æ–±—â–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É, —á—Ç–æ –ø–æ—è–≤–∏–ª–∏—Å—å –ø–µ—Ä–≤—ã–µ –∑–∞—è–≤–∫–∏ –∏ –ø–æ–ø—Ä–æ—Å–∏—Ç–µ —É –Ω–µ–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ—Ç—á–µ—Ç–∞.",
        "system-alert"
      );
      setCurrentStage("STAGE_5_REPORT");
      break;

    case "STAGE_5_REPORT":
      addMessage(
        "–•–æ—Ä–æ—à–æ, —Å–æ–±–µ—Ä—É –¥–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –∏ –ø—Ä–∏—à–ª—é –≤–∞–º –ø–æ–∑–∂–µ.",
        "bot"
      );
      await sleep(2000);
      addMessage(
        "**–ü—Ä–æ—à–ª–æ 3 —á–∞—Å–∞. –ö–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.** –ù–∞–ø–æ–º–Ω–∏—Ç–µ –µ–º—É –æ —Ç–æ–º, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ—Ç—á–µ—Ç–∞ –ø–æ —Ä–µ–∫–ª–∞–º–µ.",
        "system"
      );
      setCurrentStage("STAGE_6_REPORT_WAIT");
      break;

    case "STAGE_6_REPORT_WAIT":
      addMessage(
        "–£ –º–µ–Ω—è —Ç—É—Ç –¥–æ–º–∞ –ø–æ—Ç–æ–ø, –º–Ω–µ –Ω–µ –¥–æ –≤–∞—à–∏—Ö —Ü–∏—Ñ—Ä. –ü—Ä–∏—à–ª—é –∫–∞–∫ —Å–º–æ–≥—É",
        "bot"
      );
      await sleep(2000);
      addMessage(
        "**–ù–∞—Å—Ç—É–ø–∏–ª–æ 16 —Ñ–µ–≤—Ä–∞–ª—è.** –ù–∞—Å—Ç–æ–π—á–∏–≤–æ –Ω–∞–ø–æ–º–Ω–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—á–µ—Ç–∞.",
        "system"
      );
      setCurrentStage("STAGE_7_REPORT_DATA");
      break;

    case "STAGE_7_REPORT_DATA":
      addMessage(
        "–Ø —Ç—É—Ç –∏—Å–∫–∞–ª–∞ —Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞, —É–±–∏—Ä–∞–ª–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É –∏ —Ä–µ—à–∞–ª–∞ –≤–æ–ø—Ä–æ—Å —Å —Å–æ—Å–µ–¥—è–º–∏, —Ç–∞–∫ –∫–∞–∫ —è –∏—Ö –∑–∞–ª–∏–ª–∞.",
        "bot"
      );
      await sleep(1500);
      addMessage(
        "–ú—ã –ø—Ä–æ–¥–∞–ª–∏ 20 –±—É–∫–µ—Ç–æ–≤ –∏ –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ 55 300 —Ä—É–±. –ê –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –æ—Ç—á–µ—Ç –ø–æ —Ä–µ–∫–ª–∞–º–µ?",
        "bot"
      );
      await sleep(1000);
      addMessage(
        "**–ó–∞–¥–∞—á–∞:** –†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –≤—Å–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –æ—Ç—á–µ—Ç–∞ (–≤ —Ä–∞–∑–¥–µ–ª–µ 5) –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É \"–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç\".",
        "system-alert"
      );
      setCurrentStage("STAGE_7_REPORT_DATA_2");
      break;

    case "STAGE_7_REPORT_DATA_2":
      addMessage(
        "–ù–∞–ø–æ–º–∏–Ω–∞—é: –Ω–∞–∂–º–∏—Ç–µ \"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç\" –≤ —Ä–µ–∫–ª–∞–º–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—Ç—á–µ—Ç.",
        "system-alert"
      );
      break;

    case "STAGE_8_REPORT_SUBMIT":
      addMessage("–ü–æ—Å–º–æ—Ç—Ä—é –æ—Ç—á–µ—Ç –∑–∞–≤—Ç—Ä–∞", "bot");
      await sleep(2000);
      addMessage("**–ù–∞—Å—Ç—É–ø–∏–ª–æ 17 —Ñ–µ–≤—Ä–∞–ª—è.**", "system");
      await sleep(1000);
      addMessage(
        "–ü–æ—Å–º–æ—Ç—Ä–µ–ª–∞ –≤–∞—à –æ—Ç—á–µ—Ç. –ù–æ —è –Ω–∏—á–µ–≥–æ –≤ –Ω–µ–º –Ω–µ –ø–æ–Ω–∏–º–∞—é. –ß—Ç–æ —Ç–∞–∫–æ–µ CTR –∏ –≤—Å–µ –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–µ –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—ã. –ü–æ—è—Å–Ω–∏—Ç–µ –º–Ω–µ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.",
        "bot"
      );
      await sleep(500);
      addMessage(
        "**–ó–∞–¥–∞—á–∞:** –û–±—ä—è—Å–Ω–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, —á—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (CTR, CPC, CPM, CR, CPL, ROMI).",
        "system-alert"
      );
      setCurrentStage("STAGE_9_EXPLAIN");
      break;

    case "STAGE_9_EXPLAIN":
      addMessage("–í–æ—Ç —Ç–µ–ø–µ—Ä—å –≤—Å–µ –ø–æ–Ω—è—Ç–Ω–æ.", "bot");
      await sleep(1000);
      addMessage(
        "–°–ø–∞—Å–∏–±–æ –≤–∞–º –∑–∞ —Ä–∞–±–æ—Ç—É! –†–µ–∑—É–ª—å—Ç–∞—Ç –º–µ–Ω—è —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç. –î–∞–≤–∞–π—Ç–µ –≤ —Å–ª–µ–¥—É—é—â–µ–º –º–µ—Å—è—Ü–µ —Å–Ω–æ–≤–∞ –∑–∞–ø—É—Å—Ç–∏–º —Ä–µ–∫–ª–∞–º—É.",
        "bot"
      );
      await sleep(1500);
      addMessage(
        "**–ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∫–µ–π—Å.** –í—ã –ø—Ä–æ—à–ª–∏ –≤–µ—Å—å –ø—É—Ç—å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞ ‚Äî –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º –¥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ, –≤–≤–µ–¥—è –∫–æ–º–∞–Ω–¥—É /start",
        "system"
      );
      setCurrentStage("FINAL");
      break;

    case "FINAL":
      addMessage(
        "–ö–µ–π—Å –∑–∞–≤–µ—Ä—à–µ–Ω. –í–≤–µ–¥–∏—Ç–µ /start —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.",
        "system-alert"
      );
      break;

    default:
      break;
  }
};
